<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <title>Permit Navigation Link Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-full bg-slate-950 text-slate-50">
  <div class="min-h-screen flex items-center justify-center px-4 py-10">
    <div class="w-full max-w-6xl grid lg:grid-cols-[minmax(0,2.2fr)_minmax(0,1.6fr)] gap-6">
      <!-- LEFT: Header + Form + Result text -->
      <div class="bg-slate-900/80 border border-slate-700 rounded-2xl shadow-2xl shadow-blue-500/20 p-6 md:p-8 flex flex-col">
        <!-- Header -->
        <header class="mb-6 flex items-center justify-between gap-4">
          <div>
            <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">
              Permit Navigation Link Generator
            </h1>
            <p class="mt-1 text-sm text-slate-400">
              Starting / Destination — address (optional) + permit PDFs → Google Maps navigation link.
            </p>
          </div>
          <span class="inline-flex items-center gap-1 rounded-full bg-emerald-500/10 px-3 py-1 text-xs font-medium text-emerald-300 border border-emerald-500/40">
            <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
            Live prototype
          </span>
        </header>

        <div class="grid md:grid-cols-2 gap-6 flex-1">
          <!-- FORM -->
          <section class="space-y-4">
            <!-- Address inputs -->
            <div class="space-y-3">
              <div>
                <label class="block text-xs font-medium text-slate-300 mb-1">
                  Starting address (optional)
                </label>
                <input
                  id="start-text"
                  type="text"
                  placeholder="e.g. Reliable Rebar, 224 Capital Lane, Rhome, TX"
                  class="w-full rounded-lg border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500/70 focus:border-blue-500/70"
                />
              </div>

              <div>
                <label class="block text-xs font-medium text-slate-300 mb-1">
                  Destination address (optional)
                </label>
                <input
                  id="end-text"
                  type="text"
                  placeholder="e.g. Boone, CO"
                  class="w-full rounded-lg border border-slate-700 bg-slate-900/70 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-purple-500/70 focus:border-purple-500/70"
                />
              </div>

              <p class="text-[11px] text-slate-500">
                If you don’t know the exact addresses, you can just upload the permit PDFs — the AI will detect pickup
                and delivery for you.
              </p>
            </div>

            <!-- Single upload for ALL permits -->
            <div class="border border-dashed border-slate-600 rounded-xl p-4 bg-slate-900/60">
              <label
                for="permits"
                class="flex flex-col items-center justify-center gap-2 cursor-pointer text-center"
              >
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-blue-500/20 text-blue-300 mb-1">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                       viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8"
                          d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1M16 12l-4-4m0 0L8 12m4-4v12" />
                  </svg>
                </div>
                <p class="text-sm font-medium">
                  Upload <span class="text-blue-300">permits</span> (PDF, multi)
                </p>
                <p class="text-xs text-slate-400">
                  Drop your rate confirmation, TX PERMIT, CO PERMIT and other files here (4–20 PDFs recommended).
                </p>
                <input
                  id="permits"
                  type="file"
                  class="hidden"
                  accept="application/pdf"
                  multiple
                />
                <p id="permits-label" class="mt-2 text-xs text-slate-400">
                  No files selected yet
                </p>
              </label>

              <!-- File tags -->
              <div id="file-tags" class="mt-3 flex flex-wrap gap-1.5 text-[11px]"></div>
            </div>

            <!-- Advanced options (hidden by default) -->
            <div class="mt-1">
              <button
                id="toggle-advanced"
                type="button"
                class="text-[11px] text-slate-400 hover:text-slate-200 inline-flex items-center gap-1"
              >
                <span id="toggle-advanced-icon">▸</span>
                <span>Show advanced options</span>
              </button>

              <div id="advanced-panel" class="mt-3 space-y-2 hidden">
                <div class="flex items-center justify-between gap-2">
                  <span class="text-[11px] uppercase tracking-wide text-slate-400">Travel mode</span>
                  <span id="travel-mode-label" class="text-[11px] text-slate-300">
                    Driving
                  </span>
                </div>
                <div class="inline-flex flex-wrap gap-1.5 rounded-full bg-slate-900/70 p-1 border border-slate-700">
                  <button
                    type="button"
                    class="travel-mode-btn px-3 py-1 text-[11px] rounded-full bg-blue-500 text-slate-950 font-medium shadow-sm"
                    data-mode="driving"
                  >
                    Driving
                  </button>
                  <button
                    type="button"
                    class="travel-mode-btn px-3 py-1 text-[11px] rounded-full text-slate-200 hover:bg-slate-800"
                    data-mode="walking"
                  >
                    Walking
                  </button>
                  <button
                    type="button"
                    class="travel-mode-btn px-3 py-1 text-[11px] rounded-full text-slate-200 hover:bg-slate-800"
                    data-mode="bicycling"
                  >
                    Cycling
                  </button>
                  <button
                    type="button"
                    class="travel-mode-btn px-3 py-1 text-[11px] rounded-full text-slate-200 hover:bg-slate-800"
                    data-mode="transit"
                  >
                    Transit
                  </button>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="flex flex-col sm:flex-row gap-2 pt-1">
              <button
                id="submit-btn"
                class="flex-1 inline-flex items-center justify-center gap-2 rounded-xl bg-blue-500 hover:bg-blue-600 active:bg-blue-700 transition-colors px-4 py-2.5 text-sm font-semibold shadow-lg shadow-blue-500/30 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <span>Generate link</span>
                <svg id="btn-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                     viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.8"
                        d="M5 12h14M13 6l6 6-6 6" />
                </svg>
                <svg id="btn-spinner" xmlns="http://www.w3.org/2000/svg"
                     class="hidden h-4 w-4 animate-spin"
                     viewBox="0 0 24 24" fill="none">
                  <circle class="opacity-25" cx="12" cy="12" r="10"
                          stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                </svg>
              </button>

              <button
                id="clear-btn"
                type="button"
                class="sm:w-32 inline-flex items-center justify-center rounded-xl border border-slate-600 bg-slate-900/70 hover:bg-slate-800 px-3 py-2 text-xs font-medium text-slate-200"
              >
                Clear form
              </button>
            </div>

            <p id="error-box" class="hidden text-xs text-red-400 bg-red-950/40 border border-red-700/60 rounded-lg px-3 py-2"></p>
          </section>

          <!-- RESULT TEXT -->
          <section class="space-y-4">
            <div class="border border-slate-700 rounded-xl bg-slate-900/60 p-4 h-full flex flex-col">
              <div class="flex items-center justify-between mb-2">
                <h2 class="text-sm font-semibold text-slate-100">
                  Result
                </h2>
                <span id="llm-badge" class="hidden text-[11px] px-2 py-0.5 rounded-full bg-slate-800 text-slate-300 border border-slate-600">
                  LLM: Gemini
                </span>
              </div>

              <div id="empty-state" class="text-xs text-slate-400 flex-1 flex items-center">
                Origin / Destination / Notes will appear here after generation.
              </div>

              <div id="result-card" class="hidden flex-1 flex flex-col gap-3">
                <div class="space-y-1">
                  <p class="text-[11px] uppercase tracking-wide text-slate-400">Origin</p>
                  <p id="origin-text" class="text-sm font-medium text-slate-50"></p>
                </div>

                <div class="space-y-1">
                  <p class="text-[11px] uppercase tracking-wide text-slate-400">Destination</p>
                  <p id="destination-text" class="text-sm font-medium text-slate-50"></p>
                </div>

                <div class="space-y-1">
                  <p class="text-[11px] uppercase tracking-wide text-slate-400">Notes</p>
                  <p id="notes-text" class="text-xs text-slate-300"></p>
                </div>

                <div class="mt-2 flex flex-wrap gap-2">
                  <a
                    id="maps-link"
                    href="#"
                    target="_blank"
                    class="inline-flex items-center gap-2 rounded-lg bg-emerald-500/90 hover:bg-emerald-500 px-3 py-1.5 text-xs font-semibold text-slate-950 transition-colors"
                  >
                    Open in Google Maps
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none"
                         viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.7"
                            d="M13 5h6m0 0v6m0-6L10 14" />
                    </svg>
                  </a>

                  <button
                    id="copy-link"
                    class="inline-flex items-center gap-2 rounded-lg border border-slate-600 bg-slate-900/60 hover:bg-slate-800 px-3 py-1.5 text-xs font-medium text-slate-200 transition-colors"
                  >
                    Copy link
                  </button>
                </div>
              </div>
            </div>
          </section>
        </div>

        <footer class="mt-4 text-[11px] text-slate-500 text-right">
          Built for the “Programming Estafeta” – 2 addresses (optional) + multi-permit → navigation link.
        </footer>
      </div>

      <!-- RIGHT: MAP PREVIEW CARD -->
      <div class="bg-slate-900/80 border border-slate-700 rounded-2xl shadow-xl shadow-blue-500/20 p-4 md:p-5 flex flex-col">
        <h2 class="text-sm font-semibold text-slate-100 mb-2">
          Route preview
        </h2>

        <p id="map-empty" class="text-xs text-slate-400 flex-1 flex items-center">
          Once the link is generated, a Google Maps preview will appear here.
        </p>

        <div id="map-wrapper" class="hidden mt-1 border border-slate-700 rounded-xl overflow-hidden flex-1">
          <iframe
            id="map-frame"
            src=""
            class="w-full h-full border-0"
            loading="lazy"
            referrerpolicy="no-referrer-when-downgrade"
          ></iframe>
        </div>
      </div>
    </div>
  </div>

  <script>
    const startTextInput = document.getElementById("start-text");
    const endTextInput = document.getElementById("end-text");
    const permitsInput = document.getElementById("permits");
    const permitsLabel = document.getElementById("permits-label");
    const fileTags = document.getElementById("file-tags");

    const submitBtn = document.getElementById("submit-btn");
    const clearBtn = document.getElementById("clear-btn");
    const btnIcon = document.getElementById("btn-icon");
    const btnSpinner = document.getElementById("btn-spinner");
    const errorBox = document.getElementById("error-box");

    const emptyState = document.getElementById("empty-state");
    const resultCard = document.getElementById("result-card");
    const originText = document.getElementById("origin-text");
    const destinationText = document.getElementById("destination-text");
    const notesText = document.getElementById("notes-text");
    const mapsLink = document.getElementById("maps-link");
    const copyLinkBtn = document.getElementById("copy-link");
    const llmBadge = document.getElementById("llm-badge");

    const mapWrapper = document.getElementById("map-wrapper");
    const mapFrame = document.getElementById("map-frame");
    const mapEmpty = document.getElementById("map-empty");

    const toggleAdvancedBtn = document.getElementById("toggle-advanced");
    const toggleAdvancedIcon = document.getElementById("toggle-advanced-icon");
    const advancedPanel = document.getElementById("advanced-panel");
    const travelModeLabel = document.getElementById("travel-mode-label");
    const travelModeButtons = document.querySelectorAll(".travel-mode-btn");

    let currentTravelMode = "driving";

    // --- helpers ---

    function renderFileTags() {
      fileTags.innerHTML = "";
      const files = Array.from(permitsInput.files || []);
      if (!files.length) return;

      const maxVisible = 3;
      files.slice(0, maxVisible).forEach((file) => {
        const span = document.createElement("span");
        span.className =
          "inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-slate-800 text-slate-200 border border-slate-600";
        span.textContent = file.name;
        fileTags.appendChild(span);
      });

      if (files.length > maxVisible) {
        const more = document.createElement("span");
        more.className =
          "inline-flex items-center px-2 py-0.5 rounded-full bg-slate-900 text-slate-300 border border-dashed border-slate-600 text-[11px]";
        more.textContent = `+${files.length - maxVisible} more`;
        fileTags.appendChild(more);
      }
    }

    permitsInput.addEventListener("change", () => {
      const count = permitsInput.files.length;
      if (!count) {
        permitsLabel.textContent = "No files selected yet";
      } else if (count === 1) {
        permitsLabel.textContent = permitsInput.files[0].name;
      } else {
        permitsLabel.textContent = `${count} PDF files selected`;
      }
      renderFileTags();
    });

    function setLoading(isLoading) {
      submitBtn.disabled = isLoading;
      btnIcon.classList.toggle("hidden", isLoading);
      btnSpinner.classList.toggle("hidden", !isLoading);
    }

    function resetForm() {
      startTextInput.value = "";
      endTextInput.value = "";
      permitsInput.value = "";
      permitsLabel.textContent = "No files selected yet";
      fileTags.innerHTML = "";

      errorBox.classList.add("hidden");
      errorBox.textContent = "";

      originText.textContent = "";
      destinationText.textContent = "";
      notesText.textContent = "";
      llmBadge.classList.add("hidden");

      resultCard.classList.add("hidden");
      emptyState.classList.remove("hidden");

      mapFrame.src = "";
      mapWrapper.classList.add("hidden");
      mapEmpty.classList.remove("hidden");
    }

    clearBtn.addEventListener("click", (e) => {
      e.preventDefault();
      resetForm();
    });

    // Advanced options toggle
    toggleAdvancedBtn.addEventListener("click", () => {
      const isHidden = advancedPanel.classList.contains("hidden");
      advancedPanel.classList.toggle("hidden", !isHidden);
      toggleAdvancedIcon.textContent = isHidden ? "▾" : "▸";
      toggleAdvancedBtn.querySelector("span:nth-child(2)").textContent = isHidden
        ? "Hide advanced options"
        : "Show advanced options";
    });

    // Travel mode pills
    travelModeButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        currentTravelMode = btn.dataset.mode || "driving";
        travelModeButtons.forEach((b) => {
          if (b === btn) {
            b.classList.add("bg-blue-500", "text-slate-950", "font-medium", "shadow-sm");
            b.classList.remove("text-slate-200", "hover:bg-slate-800");
          } else {
            b.classList.remove("bg-blue-500", "text-slate-950", "font-medium", "shadow-sm");
            b.classList.add("text-slate-200", "hover:bg-slate-800");
          }
        });
        travelModeLabel.textContent =
          currentTravelMode.charAt(0).toUpperCase() + currentTravelMode.slice(1);
      });
    });

    async function handleSubmit() {
      errorBox.classList.add("hidden");
      errorBox.textContent = "";

      const start = startTextInput.value.trim();
      const end = endTextInput.value.trim();
      const hasPermits = !!permitsInput.files.length;

      if (!hasPermits && !(start && end)) {
        errorBox.textContent =
          "Please upload at least one permit PDF or provide both starting and destination addresses.";
        errorBox.classList.remove("hidden");
        return;
      }

      const formData = new FormData();
      formData.append("start_address", start);
      formData.append("end_address", end);
      formData.append("travel_mode", currentTravelMode);

      Array.from(permitsInput.files).forEach((file) => {
        formData.append("permits", file);
      });

      setLoading(true);

      try {
        // NOTE: change this URL if backend lives elsewhere
        const res = await fetch("https://nav-api.misterdev.uz/api/generate-navigation-link", {
        // const res = await fetch("http://127.0.0.1:8003/api/generate-navigation-link", {
          method: "POST",
          body: formData,
        });

        const raw = await res.text();
        if (!raw) {
          throw new Error("Server returned an empty response.");
        }

        let data;
        try {
          data = JSON.parse(raw);
        } catch (e) {
          console.error("JSON parse error. Raw:", raw);
          throw new Error("Server did not return valid JSON.");
        }

        if (!res.ok || !data.success) {
          throw new Error(data.detail || "Server error.");
        }

        originText.textContent = data.origin || "-";
        destinationText.textContent = data.destination || "-";
        notesText.textContent = data.notes || "";
        mapsLink.href = data.google_maps_link || "#";

        if (data.used_gemini === true) {
          llmBadge.textContent = "LLM: Gemini (permits used)";
          llmBadge.classList.remove("hidden");
        } else {
          llmBadge.textContent = "LLM: direct addresses";
          llmBadge.classList.remove("hidden");
        }

        emptyState.classList.add("hidden");
        resultCard.classList.remove("hidden");

        // Map preview
        if (data.google_maps_link) {
          const embedUrl = data.google_maps_link.includes("output=embed")
            ? data.google_maps_link
            : data.google_maps_link + "&output=embed";

          mapFrame.src = embedUrl;
          mapEmpty.classList.add("hidden");
          mapWrapper.classList.remove("hidden");
        }
      } catch (err) {
        console.error(err);
        errorBox.textContent = err.message || "Unknown error occurred.";
        errorBox.classList.remove("hidden");
      } finally {
        setLoading(false);
      }
    }

    submitBtn.addEventListener("click", (e) => {
      e.preventDefault();
      handleSubmit();
    });

    copyLinkBtn.addEventListener("click", async () => {
      const url = mapsLink.href;
      if (!url || url === "#") return;
      try {
        await navigator.clipboard.writeText(url);
        copyLinkBtn.textContent = "Copied!";
        setTimeout(() => (copyLinkBtn.textContent = "Copy link"), 1200);
      } catch {
        // ignore
      }
    });
  </script>
</body>
</html>
